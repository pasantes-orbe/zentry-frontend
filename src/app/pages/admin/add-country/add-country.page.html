<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button default-href="/admin/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Añadir Nuevo Country</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- ✅ NUEVA SECCIÓN: Indicador de paso actual -->
  <ion-card>
    <ion-card-content>
      <ion-text color="primary">
        <h3>{{ currentStep === 1 ? 'Paso 1: Marcar Centro del Barrio' : 'Paso 2: Marcar Perímetro del Barrio' }}</h3>
      </ion-text>
      <p *ngIf="currentStep === 1">Arrastra el marcador o haz clic para posicionar el centro del barrio.</p>
      <p *ngIf="currentStep === 2">Haz clic en 4 puntos del mapa para delimitar el perímetro. Puntos marcados: {{ perimeterPoints.length }}/4</p>
      
      <!-- Botones de control del mapa -->
      <div *ngIf="currentStep === 1">
        <ion-button expand="block" color="success" (click)="confirmCenter()">
          Confirmar Centro y Continuar
        </ion-button>
      </div>
      
      <div *ngIf="currentStep === 2">
        <ion-button expand="block" color="warning" (click)="resetPerimeter()" [disabled]="perimeterPoints.length === 0">
          Reiniciar Perímetro
        </ion-button>
        <ion-button expand="block" color="medium" (click)="backToStep1()">
          Volver al Paso 1
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Contenedor del mapa (sin cambios) -->
  <div id="map" class="map-container"></div>

  <!-- ✅ FORMULARIO: Solo se muestra cuando el perímetro está completo -->
  <form [formGroup]="form" (ngSubmit)="addCountry()" class="form-container" *ngIf="currentStep === 2 && perimeterPoints.length === 4">
    <!-- Nombre del Country -->
    <ion-item>
      <ion-label position="floating">Nombre del Country<ion-text color="danger">*</ion-text></ion-label>
      <ion-input formControlName="countryName" required type="text"></ion-input>
    </ion-item>

    <!-- Dirección -->
    <ion-item>
      <ion-label position="floating">Dirección<ion-text color="danger">*</ion-text></ion-label>
      <ion-input formControlName="address" required type="text"></ion-input>
    </ion-item>

    <!-- Localidad -->
    <ion-item>
      <ion-label position="floating">Localidad</ion-label>
      <ion-input formControlName="locality" type="text"></ion-input>
    </ion-item>

    <!-- Teléfono de Contacto -->
    <ion-item>
      <ion-label position="floating">Teléfono de Contacto</ion-label>
      <ion-input formControlName="phone" type="tel"></ion-input>
    </ion-item>

    <!-- Avatar del Country -->
    <ion-item>
      <ion-label>Avatar del Country<ion-text color="danger">*</ion-text></ion-label>
      <input type="file" (change)="onFileChange($event)" />
    </ion-item>

    <!-- Vista previa del avatar -->
    <div *ngIf="newImg" class="avatar-preview-container">
      <img [src]="newImg" alt="Vista previa del avatar" class="avatar-preview" />
    </div>

    <!-- ✅ ACTUALIZADO: Coordenadas del centro y perímetro -->
    <ion-item>
      <ion-label position="stacked">Centro del Barrio</ion-label>
      <ion-text>{{ lat }}, {{ lng }}</ion-text>
    </ion-item>

    <ion-item *ngIf="perimeterPoints.length === 4">
      <ion-label position="stacked">Perímetro Definido</ion-label>
      <ion-text color="success">✓ 4 puntos marcados correctamente</ion-text>
    </ion-item>

    <!-- Botón Guardar -->
    <ion-button class="submit-button" size="large" expand="block" color="primary" type="submit" [disabled]="form.invalid">
      Guardar Country
    </ion-button>
  </form>

  <!-- ✅ MENSAJE: Cuando el formulario no está disponible -->
  <ion-card *ngIf="currentStep === 1 || perimeterPoints.length < 4">
    <ion-card-content>
      <ion-text color="medium">
        <p>Complete la marcación del mapa para acceder al formulario de datos del country.</p>
      </ion-text>
    </ion-card-content>
  </ion-card>
</ion-content>